{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - PCBulacan</title>
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Products page specific styles */
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .products-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-btn {
            padding: 0.625rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .product-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f8fafc;
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-category {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }
        
        .product-stock {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .stock-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stock-badge.in-stock {
            background: #d1fae5;
            color: #065f46;
        }
        
        .stock-badge.low-stock {
            background: #fef3c7;
            color: #92400e;
        }
        
        .stock-badge.out-of-stock {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .product-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .action-btn.edit {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .action-btn.edit:hover {
            background: #3b82f6;
            color: white;
        }
        
        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-btn.delete:hover {
            background: #ef4444;
            color: white;
        }
        
        /* Table view */
        .products-table {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .products-table table {
            width: 100%;
        }
        
        .products-table img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .image-upload {
            border: 2px dashed #e2e8f0;
            border-radius: 0.375rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .image-upload:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }
        
        .image-upload i {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        
        .image-preview {
            max-width: 200px;
            margin: 1rem auto;
            display: none;
        }
        
        .image-preview img {
            width: 100%;
            border-radius: 0.375rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .btn-cancel {
            padding: 0.625rem 1.25rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-submit {
            padding: 0.625rem 1.25rem;
            border: none;
            background: #2563eb;
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-submit:hover {
            background: #1d4ed8;
        }
        
        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.25rem;
            background: white;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.3s;
        }
        
        .view-toggle button.active {
            background: #2563eb;
            color: white;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        .pagination button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        {% include 'includes/admin_sidebar.html' %}

        <!-- Main Content -->
        <div class="admin-content">
            <!-- Header -->
            {% include 'includes/admin_header.html' with page_title="Manage Products" %}

            <!-- Products Content -->
            <div class="dashboard-wrapper">
                <div class="products-header">
                    <div>
                        <h1 class="dashboard-title">Manage Products</h1>
                        <p style="color: #64748b; margin-top: 0.5rem;">Total: {{ products.count }} products</p>
                    </div>
                    
                    <div class="products-actions">
                        <div class="view-toggle">
                            <button class="active" id="gridView">
                                <i class="fas fa-th"></i> Grid
                            </button>
                            <button id="tableView">
                                <i class="fas fa-list"></i> Table
                            </button>
                        </div>
                        
                        <button class="btn btn-primary" onclick="openAddModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
                    </div>
                    
                    <select id="categoryFilter" onchange="filterProducts()" style="padding: 0.625rem 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" onclick="setStockFilter('all')">All</button>
                        <button class="filter-btn" data-filter="in-stock" onclick="setStockFilter('in-stock')">In Stock</button>
                        <button class="filter-btn" data-filter="low-stock" onclick="setStockFilter('low-stock')">Low Stock</button>
                        <button class="filter-btn" data-filter="out-of-stock" onclick="setStockFilter('out-of-stock')">Out of Stock</button>
                    </div>
                </div>

                <!-- Grid View -->
                <div class="products-grid" id="productsGrid">
                    {% for product in products %}
                    <div class="product-card" data-category="{{ product.category.id }}" data-stock="{{ product.stock }}" data-name="{{ product.name|lower }}">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                        {% else %}
                        <img src="{% static 'images/no-image.png' %}" alt="{{ product.name }}" class="product-image">
                        {% endif %}
                        
                        <div class="product-info">
                            <div class="product-category">{{ product.category.name }}</div>
                            <div class="product-name">{{ product.name }}</div>
                            <div class="product-price">₱{{ product.price|floatformat:2 }}</div>
                            
                            <div class="product-stock">
                                <span style="font-size: 0.875rem; color: #64748b;">Stock:</span>
                                <span class="stock-badge {% if product.stock == 0 %}out-of-stock{% elif product.stock <= 10 %}low-stock{% else %}in-stock{% endif %}">
                                    {{ product.stock }}
                                </span>
                            </div>
                            
                            <div class="product-actions">
                                <button class="action-btn edit" onclick="openEditModal({{ product.id }})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="action-btn delete" onclick="deleteProduct({{ product.id }})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Table View (Hidden by default) -->
                <div class="products-table" id="productsTable" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 80px;">Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr data-category="{{ product.category.id }}" data-stock="{{ product.stock }}" data-name="{{ product.name|lower }}">
                                <td>
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                                    {% else %}
                                    <img src="{% static 'images/no-image.png' %}" alt="{{ product.name }}">
                                    {% endif %}
                                </td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.category.name }}</td>
                                <td>₱{{ product.price|floatformat:2 }}</td>
                                <td>{{ product.stock }}</td>
                                <td>
                                    <span class="stock-badge {% if product.stock == 0 %}out-of-stock{% elif product.stock <= 10 %}low-stock{% else %}in-stock{% endif %}">
                                        {% if product.stock == 0 %}Out of Stock{% elif product.stock <= 10 %}Low Stock{% else %}In Stock{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn edit" onclick="openEditModal({{ product.id }})" style="margin-right: 0.5rem;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deleteProduct({{ product.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Product</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="productForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="productId" name="product_id">
                    
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" name="name" id="productName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category *</label>
                            <select name="category" id="productCategory" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Price *</label>
                            <input type="number" name="price" id="productPrice" step="0.01" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Stock *</label>
                            <input type="number" name="stock" id="productStock" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label>SKU</label>
                            <input type="text" name="sku" id="productSKU" placeholder="Leave empty for auto-generation">
                            <small style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; display: block;">Stock Keeping Unit (optional, must be unique)</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" id="productDescription"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Primary Product Image *</label>
                        <div class="image-upload" onclick="document.getElementById('productImage').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload primary image</p>
                            <small style="color: #64748b;">PNG, JPG up to 5MB</small>
                        </div>
                        <input type="file" id="productImage" name="image" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        <div class="image-preview" id="imagePreview">
                            <img src="" alt="Preview" id="previewImg">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Images (Optional)</label>
                        <div class="image-upload" onclick="document.getElementById('additionalImages').click()">
                            <i class="fas fa-images"></i>
                            <p>Click to upload additional images</p>
                            <small style="color: #64748b;">Select multiple images (up to 5)</small>
                        </div>
                        <input type="file" id="additionalImages" name="additional_images" accept="image/*" multiple style="display: none;" onchange="previewAdditionalImages(this)">
                        <div id="additionalImagesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                            <!-- Additional image previews will appear here -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // View toggle
        document.getElementById('gridView').addEventListener('click', function() {
            document.getElementById('productsGrid').style.display = 'grid';
            document.getElementById('productsTable').style.display = 'none';
            this.classList.add('active');
            document.getElementById('tableView').classList.remove('active');
        });
        
        document.getElementById('tableView').addEventListener('click', function() {
            document.getElementById('productsGrid').style.display = 'none';
            document.getElementById('productsTable').style.display = 'block';
            this.classList.add('active');
            document.getElementById('gridView').classList.remove('active');
        });
        
        // Modal functions
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('additionalImagesPreview').innerHTML = '';
            document.getElementById('productModal').classList.add('active');
        }
        
        function openEditModal(productId) {
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = productId;
            
            // Fetch product data via AJAX
            fetch(`/dashboard/products/edit/${productId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('productName').value = data.name;
                    document.getElementById('productCategory').value = data.category_id;
                    document.getElementById('productPrice').value = data.price;
                    document.getElementById('productStock').value = data.stock;
                    document.getElementById('productSKU').value = data.sku || '';
                    document.getElementById('productDescription').value = data.description || '';
                    
                    if (data.image) {
                        document.getElementById('previewImg').src = data.image;
                        document.getElementById('imagePreview').style.display = 'block';
                    }
                    
                    // Show existing additional images
                    const additionalPreview = document.getElementById('additionalImagesPreview');
                    additionalPreview.innerHTML = '';
                    if (data.additional_images && data.additional_images.length > 0) {
                        data.additional_images.forEach(img => {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.style.cssText = 'position: relative; border: 2px solid #e2e8f0; border-radius: 0.375rem; overflow: hidden; aspect-ratio: 1;';
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = img.url;
                            imgElement.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.innerHTML = '&times;';
                            removeBtn.style.cssText = 'position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 1.25rem; line-height: 1; display: flex; align-items: center; justify-content: center;';
                            removeBtn.onclick = function() {
                                if (confirm('Delete this image?')) {
                                    // Call delete API
                                    fetch(`/dashboard/products/delete-image/${img.id}/`, {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    })
                                    .then(response => response.json())
                                    .then(result => {
                                        if (result.success) {
                                            imageWrapper.remove();
                                        } else {
                                            alert('Error deleting image');
                                        }
                                    });
                                }
                            };
                            
                            imageWrapper.appendChild(imgElement);
                            imageWrapper.appendChild(removeBtn);
                            additionalPreview.appendChild(imageWrapper);
                        });
                    }
                    
                    document.getElementById('productModal').classList.add('active');
                })
                .catch(error => console.error('Error:', error));
        }
        
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }
        
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function previewAdditionalImages(input) {
            const previewContainer = document.getElementById('additionalImagesPreview');
            previewContainer.innerHTML = '';
            
            if (input.files) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageWrapper = document.createElement('div');
                        imageWrapper.style.cssText = 'position: relative; border: 2px solid #e2e8f0; border-radius: 0.375rem; overflow: hidden; aspect-ratio: 1;';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.style.cssText = 'position: absolute; top: 0.25rem; right: 0.25rem; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 1.25rem; line-height: 1; display: flex; align-items: center; justify-content: center;';
                        removeBtn.onclick = function() {
                            imageWrapper.remove();
                            // Remove file from input (complex, so we'll handle on submit)
                        };
                        
                        imageWrapper.appendChild(img);
                        imageWrapper.appendChild(removeBtn);
                        previewContainer.appendChild(imageWrapper);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }
        
        // Delete product
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                fetch(`/dashboard/products/delete/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting product: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
        
        // Filter products
        let currentStockFilter = 'all';
        
        function filterProducts() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const cards = document.querySelectorAll('.product-card');
            const rows = document.querySelectorAll('.products-table tbody tr');
            
            [...cards, ...rows].forEach(item => {
                const name = item.dataset.name;
                const category = item.dataset.category;
                const stock = parseInt(item.dataset.stock);
                
                let show = true;
                
                // Search filter
                if (searchText && !name.includes(searchText)) {
                    show = false;
                }
                
                // Category filter
                if (categoryFilter && category !== categoryFilter) {
                    show = false;
                }
                
                // Stock filter
                if (currentStockFilter === 'in-stock' && stock <= 10) {
                    show = false;
                } else if (currentStockFilter === 'low-stock' && (stock === 0 || stock > 10)) {
                    show = false;
                } else if (currentStockFilter === 'out-of-stock' && stock !== 0) {
                    show = false;
                }
                
                item.style.display = show ? '' : 'none';
            });
        }
        
        function setStockFilter(filter) {
            currentStockFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterProducts();
        }
        
        // Form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const productId = document.getElementById('productId').value;
            const url = productId ? `/dashboard/products/edit/${productId}/` : '/dashboard/products/add/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error saving product: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving product');
            });
        });
        
        // Close modal on outside click
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
